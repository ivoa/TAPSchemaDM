TAPSchemaDM
===========

This is the TAP schema defined using VO-DML and created so that a mapping from a arbitrary VO-DML model to its TAP schema can be serialized. The [VO-DML tooling](https://ivoa.github.io/vo-dml/) will produce the TAP schema for a model as part of the output of the `vodmlSchema` command.

The model follows the description of TAP schema in the [TAP Standard](https://www.ivoa.net/documents/TAP/). The TAP Standard does not provide a machine-readable version of the TAP Schema - this DM fills that gap. Some of model element names themselves are different from the names used in the TAP standard (and this is reflected in the XML serialization). However, naturally the RDB serialization will produce exactly the required tables as described in the TAP Standard - although there are some additional columns produced.

## How to use

### Java

The Standard [VO-DML tooling](https://ivoa.github.io/vo-dml/) will produce a TAPSchemaDM instance in the ```.TAPSchema()``` method. The code below shows the essential steps
for storing the generated TAPSchema in a database. In this case it is for the TAPSchema for the TAPSchema itself, but it will apply for any model code generated by the VO-DML tooling - which itself does not have a direct dependency declared for this library. However, then to decode and save the TAPSchema instance in a project then a direct dependency to the  [![tapschema](https://img.shields.io/maven-central/v/org.javastro.ivoa.dm/tapschema.svg?label=tapschema)](https://central.sonatype.com/artifact/org.javastro.ivoa.dm/tapschema/) should be declared.

* Unmarshal the XML instance
* Normalise the tap schema instance to produce the extra key columns required by the database serialization
* Serialize this model instance to the database.

```java

TapschemaModel model = new TapschemaModel();
InputStream is = TapschemaModel.TAPSchema();
JAXBContext jc = model.management().contextFactory();
Unmarshaller unmarshaller = jc.createUnmarshaller(); 
JAXBElement<TapschemaModel> el = unmarshaller.unmarshal(new StreamSource(is), TapschemaModel.class);
TapschemaModel model_in = el.getValue();
org.ivoa.dm.tapschema.ColNameKeys.normalize(model_in); // note that this step is necessary before saving to the database to set up the table_name foreign keys
EntityManager em = emf.createEntityManager(); 
em.getTransaction().begin();
model_in.management().persistRefs(em);
em.persist(model_in.getContent(Schema.class).get(0)); 
em.getTransaction().commit();

```
